# UGMA, CLUSTAL and WPGMA
## CLUSTALW

A ==**heuristic and progresive(dynamic programming)**== phyloheny inference tool using ***Global Alignments***(of both DNA and Protein seqeunces); which is however considered less effective than others.

==**Gap opening or extension penalties**== are also applied in the alignment (*opening and extension are self explanatory*);

(GEP: gap extension penalty) of gaps varies depending on the sequences and positions considered
*GOP specific to each aa (e.g.: glycines are more likely
to approach a gap than valines)
* Reduced GOP in hydrophilic regions (for gaps rather in loops than in structured regions)
* GEP increased in the vicinity of other gaps (to avoid the formation of small neighboring gaps in favor of long gaps)

![alt text](<Screenshot 2024-10-22 at 09.26.40.png>)

The tool will calculate the distance matrix between sequences, which distance expresses the **relative-time distance** of **speciation** which led to these sequences ***differing through substitutions*** etc.

CLUSTAL algorithms:
: Can be performed by the ***UPGMA method (==Unweighted== Pair Groups with Arithmetic Mean)*** to calculate distance, if we are to **assume that branches were created at the same time**; ![alt text](<Screenshot 2024-10-22 at 09.34.30.png>)
Where: n is the "number of sequences" (to account for groups) 
Else, ***WPGMA method (==Weighted== Pair Groups with Arithmetic Mean)***: ![alt text](<Screenshot 2024-10-22 at 09.37.04.png>)

Difference between UPGMA and WGMA
: Where UPGMA will **factor** in the number of leaves per cluster and **cancel** out the weight of nodes by dividing with $n_A~+~n_B$, **WPGMA** ==dgafs==, thereby **no weight adjustments** are required; vibe and divide (by two).

Neighbour Joining
: The UPGMA algorithm (left) **assumes equal rates** of evolution, so that branch tips come out equal. The Neighbor-Joining (NJ) (right) algorithm allows for unequal rates of evolution, so that branch lengths are proportional to amount of change.
  - **NJ steps** in short: Start by defining nodes which contain leaves (ex. taxa) and then define the number of nodes accumuluated. 
    - Moving on, distance calculations will determine the fitness of the initial leaf nodes; through an **iterative** and **repetetive process**, which will eventualy lead to a "best fit tree".

## Calculating UPGMA: Worked Example.

![alt text](<Screenshot 2024-11-02 at 17.29.56.png>)

To more easily read the table and work on the calculations, the sequences can be renamed to A, B, C, D and E.

| Distance Matrix | A | B | C | D | E |
| :------ | :------ | :------ | :------ | :------ | :------ |
| A | \- | 8 | 15 | 38 | 30 |
| B |  | \- | ==**7**== | 45 | 40 |
| C |  |  | \- | 50 | 47 |
| D |  |  |  | \- | 20 |
| E |  |  |  |  | \- |

Now, we will first identify the smallest value within the distance matrix denoted above; this distance matrix is generated by CLUSTALW through sequence alignment in phylogenetic inference.

As the smallest distance represents the **nearest phylogenetic distance between two sequences**, they should be **grouped together**, as such:

![alt text](<Screenshot 2024-11-02 at 19.55.15.png>)

The lengths displayed at the branches result from the total distance (7), ***divided by the number of branches***:

$7 / 2 = 3.5$

Following the grouping/**rooting** of these two sequences, let's look at the rest; this involves recreating a table and recalculating distances with:

![alt text](<Screenshot 2024-10-22 at 09.37.04.png>)

| Distance Matrix | A | B, C | D | E |
| :---: | :---: | :---: | :---: | :---: |
| A | \- | ==**11.5**== | 38 | 30 |
| B, C |  | \- | 47.5 | 43.5 |
| D |  |  | \- | 20 |
| E |  |  |  | \- |

From these calculations we can see that **A and BuC share a common ancestor**, they should therefore be *anchored together*, similar to this:

![alt text](<Screenshot 2024-11-02 at 18.41.20.png>)

Having done so, we have to continue the calculations to root all leaves together; the calculations don't change much from before.

Consider that since A is an outgroup, and B and C belong to the same clade, we have to approach it differently;

* BuC were the **first pair of sequences** to be calculated, they will therefore be ***amplified*** in the subsequent calculations.
* Of course, now you have to ***divide by three***, as you amplified $d(BC, D)$ and you also have $d(D, A)$. 

$ d(ABC, D) = (2*d(BC, D) + d(A, D)) / 3 <=> $
$ (2 * 47.5 + 38) / 3 $ = ==***44.33***==

| Distance Matrix | A, BuC | D | E |
| :---: | :---: | :---: | :---: |
| A, BuC | \- | 44.33 | 34.5 |
| D |  | \- | ==**20**== |
| E |  |  | \- |

Now we have **another clade**, involving both sequences ***D and E***.

Repeat the process again, but **because we have unified ABC**, ***no amplification*** is required:

$ d(ABC, DE) = (ABC, E) + (ABC, D) / 2 <=>$
$ (39 + 44.33) / 2 $ = ==***41.665***==

| Distance Matrix | ABC | D, E |
| :---: | :---: | :---: | 
| ABC | \- | 41.67 |
| D, E |  | \- | 

These calculations should lead you to something like this:

![alt text](<Screenshot 2024-11-02 at 19.33.14.png>)

The final value obtained is the ***origin of the tree***, the original root to which ***all clades should be rooted to***.

### Calculating branch lengths:

To find branch lengths, several parameters have to be taken into account:

- Split the hypothesised tree into clades, as such to find the length of each branch within a clade, ***divide by two***. 
- To find the distance between two distant clades, divide the total distance and remember to subtract the shorter branch distances;

How does this make sense?

#### Calculating branch lengths in the worked example above:

First clade we ordered is constitued by sequences **B and C**, of which distance is 7; as such branch length for ***each leaf is 3.5***.

```
  3.5
 |------ B
-|
 |------ C
  3.5
```

Then we identify that **sequence A is a distant relative** to B and C, an ***outgroup***; 

```
        3.5
      y |------ B
    |---|
    |   |------ C
   X|     3.5
    |
    |---------- A
       5.75
```
If the *distance between clade BC to A*, is **11.5**, then length of A is:

$d(BuC, A) / 2$ => ==**5.75**==

**X** is the distance between the two points, which we *calculated in the distance matrix*; **11.5**

To calculate y:

$d(A, X) <=> d(B, X)$;

$d(A, X) - d(B, Y) => d(X, Y)$;

$5.75 - 3.5 = 2.25$;

==***y=2.25***==

Moving on, we see that the D and E sequences form their own clade;

```
              3.5
        2.25|------ B
        |---|
        |   |------ C
    |---|     3.5
    | Y |
    |   |---------- A
    |     5.75
    |
    |
    |      5?
    |   |---------- D
    |---|
      X |---------- E
           5?

```

Could be a mistake in her answers, as this contradicts everything online and even her own slides
: Branch lengths of D and E are calculated by: 

    $d(D, X) <=> d(D, E) / 4 => 5$

    Keep in mind at each stage we ***calculate distance according to how many branches our leaf is adjacent to***.

    In this case, *leaf D is adjacent to E as well as BC and A*.

    BC += 1, A += 1, D += 1, E += 1 => ==4== 

Otherwise, you would use the same logic that is seen in the previous clades.

## WPGMA

Where UPGMA implicitly assumes a **constant substitution rate**, over ==time== and phylogenetic lineages (known as the molecular clock hypothesis), WPGMA accounts for non-constant substitution rates with the addition of the ***Weight*** parametre.

A distance matrix is calculated for us, using an unknown distance calculation formula; could be manhattan or eucledian, who knows.

Begin by identifying the **closest points**, or in other words, the most **neighbourly** leaves.

| FIRST | a | b | c | d | e |
| ----- | ----- | ----- | ----- | ----- | :---: |
| **a** | 0 | ==17== | 21 | 31 | 23 |
| **b** |  | 0 | 30 | 34 | 21 |
| **c** |  |  | 0 | 28 | 39 |
| **d** |  |  |  | 0 | 43 |
| **e** |  |  |  |  | 0 |

We select ***A and B to be unified into a cluster***, we continue by recalculating distances:

$d(AB, C) <=> (d(A, C)~+~d(B, C))~/~2 <=> 21~+~30~/~2 = 25.5$
$d(AB, D) <=> (d(A, D)~+~d(B, D))~/~2 <=> 31~+~34~/~2 = 32.5$
$d(AB, E) <=> (d(A, E)~+~d(B, E))~/~2 <=> 23~+~21~/~2 = 22$

| SECOND | AB | C | D | E |
| ----- | :---- | ----- | ----- | ----- |
| AB | \- | 25.5 | 32.5 | ==22== |
| C |  | \- | 28 | 39 |
| D |  |  | \- | 43 |
| E |  |  |  | \- |

We select **AB and E to be unified** due to their minimum distance in the above matrix. Redo the same process for the next distance matrix:

$d(ABE, C) <=> (d(AB, C)~+~d(E, C))~/~2 <=> 25.5~+~39~/~2 = 32.25$
$d(ABE, D) <=> (d(AB, D)~+~d(E, D))~/~2 <=> 32.5~+~43~/~2 = 37.75$

| THIRD | ABE | C | D |
| ----- | :---- | ----- | ----- |
| **ABE** | \- | 32.25 | 37.75 |
| **C** |  | \- | 28 |
| **D** |  |  | \- |

We select **D and C to be unified** due to their minimum distance in the above matrix. Redo for one final time:

$d(ABE, DC) <=> (d(ABE, C)~+~d(ABE, D))~/~2 <=> 32.25+~37.75~/~2 = 35$

| FORD | ABE | CD |
| ----- | :---- | ----- |
| **ABE** | \- | 35 |
| **CD** |  | \- |

Done!

Now draw the tree and calculate the branch lengths to annotate.   

### Rooted tree with branch lengths

|  |  |  |  |  |  | d1 \= 8.5 |  |
| :---- | :---- | :---- | :---- | :---- | :---- | :---- | :---- |
|  |  |  |  |  | x | x | **A** |
|  |  |  | x | x |  |  |  |
|  | **d6= 6.5** |  | x | **d2 \= 2.5** | x | x | **B** |
| x | x | x | x |  |  | **d1 \= 8.5** |  |
| x |  |  | x |  |  |  |  |
| x |  |  | x |  |  |  |  |
| x |  |  | x | x | x | **E** |  |
| x |  |  |  |  | **d3 \= \`11** |  |  |
| x |  |  |  |  |  |  |  |
| x |  |  |  |  |  |  |  |
| x |  |  |  |  |  |  |  |
| x |  |  | **d4 \= 14** |  |  |  |  |
| x |  | x | x | x | **D** |  |  |
| x | x |  |  |  |  |  |  |
|  | **d5=3.5** | x | x | x | **C** |  |  |
|  |  |  | **d4 \= 14** |  |  |  |  |

#### Workings in detail:

$d1~=~d(A, B)/2 <=> 17~/~2 = 8.5$

$d2~=~d(AuB, E) - d1 <=> 11~-~8.5 = 2.5$

$d3~=~(d(A, E)~+~d(B, E))~/~4 <=> (23~+~21)~/~4 = 11$ 
^This is practically a correct way to do it but can be confusing.

$d4~=~d(C, D)/2 <=> 28~/~2 = 14$

$d5~=~d(ABE, DC)/2 - d4 <=> 17.5~-~14 = 3.5$

$d6~=~d(ABE, DC)/2 - d1 <=> 17.5~-~11 = 6.5$